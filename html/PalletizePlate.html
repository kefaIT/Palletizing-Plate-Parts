<!DOCTYPE html>

<html lang="en">

<head>
	<!-- Title -->
	<title>Palletize Plate</title>

	<!-- Metadata -->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">

	<!-- jQuery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

	<!-- Bootstrap -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
		integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
		integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
		crossorigin="anonymous"></script>

	<!-- CSS -->
	<style>
		body {
			background-color: #F5F5F5;
			max-height: 100vh;
		}

		/* Nav Bar */
		.nav-bar {
			/* Flex Container */
			width: 100%;
			height: auto;

			position: fixed;
			z-index: 2;

			display: flex;
			justify-content: space-between;
			align-items: center;

			color: #FFFFFF;
			background: linear-gradient(0, #2b0b13, 25%, #46121B);
			box-shadow: 0px 1px 3px 0px #444;
		}

		.nav-bar-logo {
			width: 10em;
			height: auto;
			margin: .5em;
		}

		.nav-bar-title {
			font-size: large;
			font-weight: bolder;
			white-space: nowrap;
			margin: .1em;
		}

		.back-button {
			width: 10em;
			height: auto;
			padding: .5em;

			font-size: larger;
			background: none;
			color: #FFFFFF;
			border: none;
		}

		/* Body Contents */
		.body-contents {
			width: 100%;
			max-height: 100vh;

			display: flex;
			flex-direction: row;
			justify-content: flex-start;

			padding-top: 3.5em;
		}

		/* Columns */
		#right-column {
			width: 75vw;
			max-height: 100vh;
			overflow-y: scroll;
		}

		#left-column {
			width: 25vw;
		}

		/* All Panels */
		.panel-default>.panel-heading {
			display: flex;
			flex-direction: row;

			justify-content: space-around;
			align-items: center;

			background-image: linear-gradient(0, #2b0b13, 25%, #46121B);
			color: #FFFFFF;
			font-size: medium;

			padding: .5em;
		}

		.panel-default {
			margin: 0em .5em;
			/* top & bottom, left & right*/
		}

		.panel-body {
			display: flex;
			flex-direction: column;
		}

		#palletized-table-panel-body {
			padding: 0;
		}

		.info-section {
			display: flex;
			flex-direction: row;
			justify-content: flex-start;
		}

		.info-label {
			font-size: larger;
			padding-right: .5em;
		}

		.info-item {
			font-size: larger;
		}

		#palletized-table-panel {
			margin-bottom: 10em;
		}

		/* Palletized Table */
		.pallet-header-row {
			font-size: larger;
			font-weight: bolder !important;
			background: #fafafa !important;
		}

		.part-row {
			padding-left: 1em !important;
		}

		.pallet-header-row:hover {
			background: #e6e6e6 !important;
		}
	</style>
</head>

<body>
	<!-- HTML -->
	<!-- Nav Bar -->
	<nav class="nav-bar">
		<img class="nav-bar-logo" src="https://kennedyfab.com/wp-content/uploads/2016/06/image002.png">
		<!-- Kennedy Fab Logo -->
		<h1 class="nav-bar-title">Palletize Parts</h1>
		<div class="back-button"></div>
	</nav>

	<!-- Body Contents -->
	<div class="body-contents">
		<div id="left-column">
			<!-- Job Info Panel -->
			<div class="panel panel-default" id="job-info-panel">
				<!-- Panel Heading -->
				<div class="panel-heading">
					Job Info
				</div>
				<!-- Job Info Panel Body-->
				<div class="panel-body">
					<!-- Info section: -->
					<div class="info-section">
						<label for="job-number" class="info-label">Job Number: </label>
						<div id="job-number" class="info-item"></div>
					</div>
				</div>
			</div>
		</div>
		<div id="right-column">
			<!-- Palletized Table Panel -->
			<div class="panel panel-default" id="palletized-table-panel">
				<div class="panel-body" id="palletized-table-panel-body">
					<!-- Palletized Table -->
					<table class="table table-striped table-condensed">
						<!-- <thead>
							<tr>
								<th>Pallet Number</th>
								<th>Assembly #</th>
								<th>Quantity</th>
								<th>Weight [lbs]</th>
							</tr>
						</thead> -->
						<tbody id="palletized-table-body"></tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<!-- JavaScript -->
	<script>
		// Global Variables/Constants:
		var jobNumber = "";

		const maxPalletWeight = 300; // Maximum weight that can be assigned to any pallet

		startPalletizationProcess(); // Start of code

		function startPalletizationProcess() {
			// Begin palletization process
			// Set URL Parameter Variables:
			urlParams = new URLSearchParams(window.location.search);
			RID = urlParams.get('rid');
			jobNumber = urlParams.get('job');
			palletizeMode = urlParams.get('pm');

			displayJobInfo();
			updatePageTitle();

			let apiUrlsArray = [];

			if (palletizeMode == "pl" || palletizeMode == "all") { // For Plasma Parts
				apiUrlsArray.push("https://kennedyfab.quickbase.com/db/bi9z9eiy4?act=API_GenResultsTable&query={'27'.EX.'" + jobNumber + "'}AND({'78'.'EX'.'Plasma'})&clist=3.78.28.51.538&options=num-10000&jsa=1");

			}
			if (palletizeMode == "pp" || palletizeMode == "all") { // For PP Parts
				apiUrlsArray.push("https://kennedyfab.quickbase.com/db/bi9z9eiy4?act=API_GenResultsTable&query={'27'.EX.'" + jobNumber + "'}AND({'78'.'EX'.'PP'})&clist=3.78.28.51.538&options=num-10000&jsa=1"); // [0]RID, [1]Process 1, [2]Assembly 
			}
			if (palletizeMode != "pl" && palletizeMode != "pp" && palletizeMode != "all") { // Wrong or Missing Palletizing Mode
				alert("Missing or Invalid URL Parameter 'pm': " + palletizeMode);
				window.history.back(-1);
			}
			getTransactionsInfo(apiUrlsArray); // Get info to populate global variables
		}


		function displayJobInfo() {
			// Displays relevant information about the job to the screen
			$("#job-number").text(jobNumber);
		}


		function updatePageTitle() {
			// Dynamically sets the page title based on palletize mode
			let pageTitle = "";
			switch (palletizeMode) {
				case "pl":
					pageTitle = "Palletize Plasma Parts";
					break;
				case "pp":
					pageTitle = "Palletize Part Processor Parts";
					break;
				case "all":
					pageTitle = "Palletize All Plate Parts";
					break;
			}
			document.title = pageTitle; // Set the page title
		}


		function getTransactionsInfo(urlsArray) {
			// Gets the transactions from the given url and creates a parts array with them
			let promiseArray = [];
			for (let i = 0; i < urlsArray.length; i++) { // for every url
				promiseArray.push(new Promise((resolve, reject) => {
					$.get(urlsArray[i], function () {
						if (qdb_data.length > 0) { // Found Transactions
							resolve(qdb_data); // Call resolve function with transactions array
						}
						else { // Didn't find transactions
							reject("Couldn't find any parts for job " + jobNumber); // Call reject function with error message
						}
					});
				}));
			}

			Promise.all(promiseArray)
				.then((transactionsArray) => {
					createPartsArray(transactionsArray); // Create an array of part objects based on the gathered part info
				})
				.catch((message) => {
					alert(message); // Display error message
					window.history.back(-1); // Go back to previous page
				});

		}


		function createPartsArray(transactionsArray) {
			// This function creates the parts array and then calls the palletizeParts function
			let partsArray = [];
			for (let i = 0; i < transactionsArray.length; i++) { // For each machine
				partsArray = []; // Clear the parts array
				for (let j = 0; j < transactionsArray[i].length; j++) {
					partsArray.push(new Part(transactionsArray[i][j])); // Create part object and append it to the parts array
				}
				palletizeParts(partsArray); // Call palletizeParts function with parts array
			}
		}


		function palletizeParts(partsArray) {
			// This function assigns parts to pallets in the pallet array and then calls the combineSmallPallets function
			let palletsArray = [new Pallet(partsArray[0])]; // Create the first pallet using the first part and add it to the array
			for (let i = 1; i < partsArray.length; i++) { // For every part
				for (let j = 0; j <= palletsArray.length; j++) { // For every pallet
					if (j == palletsArray.length) { // If there are no more pallets to check
						palletsArray.push(new Pallet(partsArray[i])); // Create a new pallet for this assembly
						break;
					}
					else if (palletsArray[j].assembly == partsArray[i].assembly) { // if the current pallet is the same assembly as the part
						if (palletsArray[j].addPart(partsArray[i])) { // Try to put the part on the pallet
							break; // Break for loop if the part fits, otherwise, try to add it to the next pallet
						}
					}
				}
			}
			combineSmallestPallets(palletsArray); // Call combineSmalletsPallets function with the pallets array
		}


		function combineSmallestPallets(palletsArray) {
			// This function combines all of the smallest pallets with the larger ones
			palletsArray.sort(function (a, b) { return b.weight - a.weight }); // Sort the pallets array from greatest to least weight

			let i = palletsArray.length - 1; // Index of the lightest pallet
			let j = 0; // Index of the heaviest pallet

			while (true) { // Loop
				if (i == j) { // If both pointers are pointing to the same pallet
					break;
				}
				if (palletsArray[j].mergePallet(palletsArray[i])) { // Try to merge the pallets
					palletsArray.pop(); // On success, pop the small pallet
					i--; // Decrement the small pallet pointer
				}
				else { // If failed to merge pallets
					j++; // Increment large pallet pointer
				}
			}
			displayPalletizedTable(palletsArray); // Call displayPalletizedTable function with pallets array
		}


		function displayPalletizedTable(palletsArray) {
			// Populates table with paelltized parts info
			let tableContents = "";

			for (let i = 0; i < palletsArray.length; i++) {
				tableContents += `
					<tr class="pallet-header-row" onclick="toggleHideParts('p${i}')">
						<td>Pallet ${i + 1}</td>
						<td>Assembly: ${palletsArray[i].assembly}</td>
						<td>${palletsArray[i].parts.length} pcs</td>
						<td>${palletsArray[i].weight.toFixed(2)} lbs</td>
					</tr>
				`
				for (let j = 0; j < palletsArray[i].parts.length; j++) {
					tableContents += `
						<tr class="part-row" name="p${i}" hidden>
							<td>RID: ${palletsArray[i].parts[j].rid}</td>
							<td>Assembly: ${palletsArray[i].parts[j].assembly}</td>
							<td>Material: ${palletsArray[i].parts[j].material}</td>
							<td>${palletsArray[i].parts[j].weight.toFixed(2)} lbs</td>
						</tr>
					`
				}
			}
			$("#palletized-table-body").append(tableContents)
		}

		function toggleHideParts(palletIndex) {
			// Hides and unhides parts rows when pallet header is clicked
			$("[name='" + palletIndex + "']").toggle();
		}

		// Classes:
		class Part {
			constructor(transactionInfo) {
				this.rid = transactionInfo[0];
				this.weight = Number(transactionInfo[4]);
				this.assembly = transactionInfo[2];
				this.material = transactionInfo[3];
			}
		}

		class Pallet {
			constructor(part) {
				this.assembly = part.assembly;
				this.weight = part.weight;
				this.parts = [part];
			}

			// Methods:
			addPart(part) {
				if (this.weight + part.weight > maxPalletWeight) { // If the part won't fit
					return false;
				}
				else {
					this.weight += part.weight;
					this.parts.push(part);
					return true;
				}
			}

			mergePallet(pallet) {
				if (this.weight + pallet.weight > maxPalletWeight) { // If the pallet is to heavy to merge
					return false;
				}
				else {
					for (let i = 0; i < pallet.parts.length; i++) {
						this.addPart(pallet.parts[i]);
					}
					return true;
				}
			}
		}

	</script>
</body>

</html>